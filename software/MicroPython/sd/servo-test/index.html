<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CYOBot Servo Test</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --card2: rgba(255, 255, 255, 0.09);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --accent: #7dd3fc;
        --danger: #fb7185;
        --ok: #86efac;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans,
          Helvetica, Arial, sans-serif;
        background: radial-gradient(1000px 700px at 10% 10%, rgba(125, 211, 252, 0.18), transparent),
          radial-gradient(900px 600px at 80% 20%, rgba(251, 113, 133, 0.16), transparent),
          radial-gradient(900px 700px at 40% 90%, rgba(134, 239, 172, 0.12), transparent),
          var(--bg);
        color: var(--text);
      }
      header {
        padding: 18px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: sticky;
        top: 0;
        backdrop-filter: blur(10px);
        background: rgba(11, 16, 32, 0.55);
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 18px 16px 60px;
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.3px;
      }
      .sub {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
        font-family: var(--mono);
      }
      .topbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 14px;
      }
      button {
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        background: rgba(255, 255, 255, 0.09);
      }
      button.danger {
        border-color: rgba(251, 113, 133, 0.35);
        background: rgba(251, 113, 133, 0.12);
      }
      button.danger:hover {
        background: rgba(251, 113, 133, 0.18);
      }
      button.accent {
        border-color: rgba(125, 211, 252, 0.4);
        background: rgba(125, 211, 252, 0.12);
      }
      button.accent:hover {
        background: rgba(125, 211, 252, 0.18);
      }
      .grid {
        margin-top: 16px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .row {
        display: grid;
        grid-template-columns: 140px 1fr 84px 70px;
        gap: 10px;
        align-items: center;
        padding: 12px;
        border-radius: 12px;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      @media (max-width: 720px) {
        .row {
          grid-template-columns: 1fr;
          gap: 8px;
        }
      }
      .label {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .label .name {
        font-weight: 800;
        font-size: 13px;
        font-family: var(--mono);
      }
      .label .hint {
        color: var(--muted);
        font-size: 12px;
      }
      input[type="range"] {
        width: 100%;
      }
      input[type="number"] {
        width: 100%;
        padding: 10px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: var(--card2);
        color: var(--text);
        font-family: var(--mono);
        font-weight: 700;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        font-family: var(--mono);
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
      }
      .pill.ok {
        border-color: rgba(134, 239, 172, 0.3);
        color: rgba(134, 239, 172, 0.95);
      }
      .pill.bad {
        border-color: rgba(251, 113, 133, 0.35);
        color: rgba(251, 113, 133, 0.95);
      }
      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.55;
      }
      code {
        font-family: var(--mono);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>CYOBot Servo Test</h1>
        <div id="sub" class="sub">Loading...</div>
        <div class="topbar">
          <span id="pill" class="pill">Status</span>
          <button id="btnCenter" class="accent" type="button">Center all (0 deg)</button>
          <button id="btnOffAll" class="danger" type="button">All off</button>
          <button id="btnReload" type="button">Reload</button>
        </div>
        <div class="foot">
          Range is clamped to <code>-90..90</code>. Use <code>All off</code> if a servo is
          jittering or binding.
        </div>
      </div>
    </header>

    <div class="wrap">
      <div id="grid" class="grid"></div>
    </div>

    <script>
      "use strict";

      const grid = document.getElementById("grid");
      const sub = document.getElementById("sub");
      const pill = document.getElementById("pill");

      const btnCenter = document.getElementById("btnCenter");
      const btnOffAll = document.getElementById("btnOffAll");
      const btnReload = document.getElementById("btnReload");

      let status = null;
      const debounceTimers = new Map();

      function setPill(ok, message) {
        pill.className = "pill " + (ok ? "ok" : "bad");
        pill.textContent = message;
      }

      async function api(path, body) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const err = (data && data.error) || ("HTTP " + res.status);
          throw new Error(err);
        }
        return data;
      }

      function channelLabel(ch) {
        const labels = (status && status.labels) || {};
        const hint = labels[String(ch)];
        if (hint) return `CH${ch} (${hint})`;
        return `CH${ch}`;
      }

      function rowTemplate(ch) {
        const label = document.createElement("div");
        label.className = "label";
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = channelLabel(ch);
        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "Angle (-90..90)";
        label.appendChild(name);
        label.appendChild(hint);

        const slider = document.createElement("input");
        slider.type = "range";
        slider.min = "-90";
        slider.max = "90";
        slider.step = "1";

        const num = document.createElement("input");
        num.type = "number";
        num.min = "-90";
        num.max = "90";
        num.step = "1";

        const btnOff = document.createElement("button");
        btnOff.className = "danger";
        btnOff.type = "button";
        btnOff.textContent = "Off";

        const row = document.createElement("div");
        row.className = "row";
        row.appendChild(label);
        row.appendChild(slider);
        row.appendChild(num);
        row.appendChild(btnOff);

        function setLocal(val) {
          slider.value = String(val);
          num.value = String(val);
        }

        function scheduleSend(val) {
          // Debounce per channel so we don't spam the microcontroller on every input event.
          if (debounceTimers.has(ch)) clearTimeout(debounceTimers.get(ch));
          debounceTimers.set(
            ch,
            setTimeout(async () => {
              try {
                await api("/api/servo", { channel: ch, angle: Number(val) });
                setPill(true, "OK");
              } catch (e) {
                setPill(false, "ERR: " + e.message);
              }
            }, 120),
          );
        }

        slider.addEventListener("input", () => {
          const v = Number(slider.value);
          num.value = String(v);
          scheduleSend(v);
        });

        num.addEventListener("change", () => {
          let v = Number(num.value);
          if (!Number.isFinite(v)) v = 0;
          if (v < -90) v = -90;
          if (v > 90) v = 90;
          setLocal(v);
          scheduleSend(v);
        });

        btnOff.addEventListener("click", async () => {
          try {
            await api("/api/servo", { channel: ch, off: true });
            setPill(true, `CH${ch} off`);
          } catch (e) {
            setPill(false, "ERR: " + e.message);
          }
        });

        // Init values from status
        const angles = (status && status.angles) || [];
        const off = (status && status.off) || [];
        const initAngle = typeof angles[ch] === "number" ? angles[ch] : 0;
        setLocal(initAngle);
        if (off[ch]) {
          // Visual hint only.
          hint.textContent = "Angle (-90..90) [OFF]";
        }

        return row;
      }

      async function loadStatus() {
        const res = await fetch("/api/status");
        status = await res.json();
        if (status && status.ok) {
          setPill(true, "OK");
          sub.textContent = `IP: ${status.ip || "?"} | Channels: ${status.channels || 16}`;
        } else {
          setPill(false, "NOT READY");
          const err = (status && status.error) || "Unknown error";
          sub.textContent = `PCA9685 init failed: ${err}`;
        }
      }

      function render() {
        grid.innerHTML = "";
        const count = (status && status.channels) || 16;
        for (let ch = 0; ch < count; ch++) grid.appendChild(rowTemplate(ch));
      }

      btnCenter.addEventListener("click", async () => {
        try {
          await api("/api/center", {});
          setPill(true, "Centered");
          await loadStatus();
          render();
        } catch (e) {
          setPill(false, "ERR: " + e.message);
        }
      });

      btnOffAll.addEventListener("click", async () => {
        try {
          await api("/api/all_off", {});
          setPill(true, "All off");
          await loadStatus();
          render();
        } catch (e) {
          setPill(false, "ERR: " + e.message);
        }
      });

      btnReload.addEventListener("click", async () => {
        await loadStatus();
        render();
      });

      (async () => {
        await loadStatus();
        render();
      })();
    </script>
  </body>
</html>

